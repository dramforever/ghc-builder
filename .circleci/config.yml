version: 2
jobs:
    build:
        docker:
            - image: circleci/node:latest
        steps:
            - checkout
            - run:
                name: Clone submodules
                command: |
                    git submodule sync --recursive
                    git submodule update --recursive --init
            - run:
                name: Install Nix
                command: |
                    export LANG=C
                    export USER=`whoami`

                    curl https://nixos.org/nix/install > install-nix.sh
                    sha256sum -c <<<"1b64d89db0bf4d6ddb36a7a9fff4b19dd96b93a65af6b245563689aba4134b77  install-nix.sh"
                    bash install-nix.sh

                    echo 'export LANG=C' >> ~/.profile
                    echo 'export USER=`whoami`' >> ~/.profile
                    echo "unset NIX_PATH" >> ~/.profile
                    echo "export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin" >> ~/.profile
                    echo "source ~/.nix-profile/etc/profile.d/nix.sh" >> ~/.profile
            - run:
                name: Basic setup
                command: |
                    nix-env -i bash
            - run:
                name: Parse version
                command: |
                    echo $(grep '^AC_INIT' ghc/configure.ac | cut -d[ -f3 | cut -d] -f1)$(date +'.%Y%m%d') > version.txt
                    echo Building GHC as version: $(cat version.txt)
            - run:
                name: Setup build environment
                command: |
                    nix-shell --argstr version $(cat version.txt) --run "echo OK"
            - run:
                name: Build GHC
                command: |
                    nix-build --argstr version $(cat version.txt) -A ghc.all
            - run:
                name: Dump artifact
                command: |
                    mkdir artifacts
                    nix-store --export $(nix-store -qR result*) > artifacts/dump.nar
            - store_artifacts:
                path: ./artifacts

